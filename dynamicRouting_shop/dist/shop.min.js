var shop;
(function (shop) {
    var ShopCtrl = (function () {
        function ShopCtrl($scope, $networking, $http) {
            // $scope.product = {}
            var _this = this;
            ShopCtrl.cartSize = 0;
            this.networking = $networking;
            this.http = $http;
            this.scope = $scope;
            this.scope.data = {};
            this.scope.data.products = [];
            $('#shoppingCartSize').text(ShopCtrl.cartSize);
            $networking.get('api/shop/product', function (data) {
                console.log(data);
                $scope.data = data;
            });
            $scope.check = function (value) {
                // console.log(value);
                $networking.get('api/shop/product?search=' + value, function (data) {
                    console.log(data);
                    $scope.data = data;
                });
            };
            $scope.productClicked = function (product) {
                $scope.product = product;
                $scope.product.quantity = 1;
            };
            $scope.addToCart = function (product) {
                // $('#addProduct').modal('toggle');
                var _this = this;
                ShopCtrl.cartSize++;
                $('#shoppingCartSize').text(ShopCtrl.cartSize);
                var a = $.param({
                    'product_id': product.product_id,
                    'quantity': product.quantity
                });
                console.log(a);
                console.log(product.product_id);
                $http({
                    method: 'POST',
                    url: '/api/shop/cart/add',
                    data: $.param({
                        'product_id': product.product_id,
                        'quantity': product.quantity
                    }),
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                })
                    .success(function (results) {
                    console.log(results);
                    if (results.status == true) {
                    }
                    else {
                    }
                });
            };
            // $scope.page = function(page){
            // 	$networking.get('api/product?page=' + page, function(data) {
            // 		 console.log(data.lastPage);
            // 		$scope.data = data;
            // 	})
            // }
            $scope.cart = function () {
                // alert('a');
                $networking.get('shop/cart', function (data) {
                    console.log('chart content---', data);
                    $scope.cart = data;
                });
            };
            $scope.add = function () {
                $networking.get('shop/add', function (data) {
                    console.log(data);
                    // $scope.films = data;
                });
            };
            $scope.gateway = function () {
                $networking.get('shop/gateway', function (data) {
                    console.log(data);
                    // $scope.films = data;
                });
            };
            $scope.checkout = function () {
                $networking.get('shop/checkout', function (data) {
                    console.log(data);
                    // $scope.films = data;
                });
            };
            $scope.order = function () {
                $networking.get('shop/order', function (data) {
                    console.log(data);
                    // $scope.films = data;
                });
            };
            $(window).scroll(function () {
                if ($(window).scrollTop() == $(document).height() - $(window).height()) {
                    _this.getData();
                }
            });
        }
        ShopCtrl.prototype.getData = function () {
            var _this = this;
            if (!ShopCtrl.nomoredata) {
                ShopCtrl.page++;
                $('#ajaxLoader').css({ 'display': 'block' });
                this.networking.get('api/shop/product?page=' + ShopCtrl.page, function (data) {
                    if (data.products && data.products.length) {
                        _this.scope.data.products = _this.scope.data.products.concat(data.products);
                    }
                    else {
                        $('#nomoreData').css({ 'display': 'block' });
                        ShopCtrl.nomoredata = true;
                    }
                    $('#ajaxLoader').css({ 'display': 'none' });
                });
            }
        };
        ShopCtrl.page = 1;
        ShopCtrl.nomoredata = false;
        return ShopCtrl;
    })();
    shop.ShopCtrl = ShopCtrl;
})(shop || (shop = {}));
/// <reference path="../Shop.ts" />
var shop;
(function (shop) {
    var ProfileCtrl = (function () {
        function ProfileCtrl($scope, $networking) {
            $scope.user = user;
        }
        return ProfileCtrl;
    })();
    shop.ProfileCtrl = ProfileCtrl;
})(shop || (shop = {}));
/// <reference path="../Shop.ts" />
var shop;
(function (shop) {
    var CartCtrl = (function () {
        function CartCtrl($scope, $networking) {
            $networking.get('api/shop/cart', function (data) {
                console.log(data);
                $scope.data = data;
            });
        }
        return CartCtrl;
    })();
    shop.CartCtrl = CartCtrl;
})(shop || (shop = {}));
/// <reference path="../Shop.ts" />
var shop;
(function (shop) {
    var MyOrderCtrl = (function () {
        function MyOrderCtrl($scope, $networking, $stateParams, $http) {
            $scope.user = user;
            // $networking.get('api/shop/order', function(data) {
            // 	// console.log(data.lastPage);
            // 	$scope.data = data;
            // })
            $http({
                method: 'GET',
                url: '/api/shop/order',
                data: $.param({
                    'user_id': user.user_id,
                    'statusCode': $stateParams.status
                }),
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            })
                .success(function (response) {
                console.log(response);
                if (response.status == true) {
                    // alert('操作成功!');
                    $scope.data = response.result;
                }
                else {
                }
            });
        }
        return MyOrderCtrl;
    })();
    shop.MyOrderCtrl = MyOrderCtrl;
})(shop || (shop = {}));
/// <reference path="../Shop.ts" />
var shop;
(function (shop) {
    var CheckoutCtrl = (function () {
        function CheckoutCtrl($scope, $networking, $http, $state) {
            this.scope = $scope;
            this.http = $http;
            this.state = $state;
            $scope.user = user;
            $networking.get('api/shop/cart', function (data) {
                console.log(data);
                $scope.data = data;
                // alert('a')
            });
            $networking.get('api/region?parent_id=1', function (data) {
                // console.log(data);
                $scope.provinces = data;
            });
            console.log(user.user_id);
            $networking.get('api/shop/address?user_id=' + user.user_id, function (data) {
                // console.log(data);
                $scope.address = data[0];
            });
            $scope.provinceSelected = function (value) {
                $networking.get('/api/region?parent_id=' + value, function (data) {
                    $scope.cities = data;
                    // console.log(data);
                });
            };
            $scope.citySelected = function (value) {
                $networking.get('/api/region?parent_id=' + value, function (data) {
                    $scope.districts = data;
                    // console.log(data);
                });
            };
            $scope.addressConfirm = function (address) {
                // $('#addProduct').modal('toggle')
                // console.log(address);
                $http({
                    method: 'POST',
                    url: '/api/shop/address',
                    data: $.param({
                        'province_id': address.province,
                        'city_id': address.city,
                        'district_id': address.district,
                        'address': address.address
                    }),
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                }).success(function (data) {
                    console.log(data);
                    if (data.status == true) {
                        // alert('操作成功!');
                        $scope.address = data.results;
                    }
                    else {
                    }
                });
            };
            // $scope.
            $scope.checkout = function (gateway) {
                if (gateway == 'wechat') {
                    // code...
                    $scope.handleWechat();
                }
                $scope.postPayment(gateway);
            };
            $scope.postPayment = function (gateway) {
                var _this = this;
                $http({
                    method: 'POST',
                    url: '/api/shop/checkout',
                    data: $.param({
                        'gateway': gateway
                    }),
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                }).success(function (data) {
                    console.log(data);
                    if (data.status == true) {
                        // alert('操作成功!');
                        $scope.address = data.results;
                        $state.go('profile');
                    }
                    else {
                        alert('操作失败!');
                    }
                });
            };
            $scope.handleWechat = function () {
                // alert('handleWechat---');
                // var _this = this;
                // if (typeof WeixinJSBridge == "undefined") {
                //     alert('请使用微信');
                //     if (document.addEventListener) {
                //         document.addEventListener('WeixinJSBridgeReady', this.onBridgeReady, false);
                //     } else if (document.attachEvent) {
                //         document.attachEvent('WeixinJSBridgeReady', this.onBridgeReady);
                //         document.attachEvent('onWeixinJSBridgeReady', this.onBridgeReady);
                //     }
                // } else {
                //     alert('pay');
                //     WeixinJSBridge.invoke('getBrandWCPayRequest', {}, function(res) {
                //         alert('got response');
                //         alert('response--' + JSON.stringify(res));
                //     });
                // }
                if (typeof WeixinJSBridge === 'undefined') {
                    alert('请在微信在打开页面！');
                    return false;
                }
                WeixinJSBridge.invoke('getBrandWCPayRequest', {}, function (res) {
                    switch (res.err_msg) {
                        case 'get_brand_wcpay_request:cancel':
                            alert('用户取消支付！');
                            break;
                        case 'get_brand_wcpay_request:fail':
                            alert('支付失败！（' + res.err_desc + '）');
                            break;
                        case 'get_brand_wcpay_request:ok':
                            alert('支付成功！');
                            break;
                        default:
                            alert(JSON.stringify(res));
                            break;
                    }
                });
            };
        } //end constructor
        return CheckoutCtrl;
    })();
    shop.CheckoutCtrl = CheckoutCtrl;
})(shop || (shop = {}));
var shop;
(function (shop) {
    var AddressCtrl = (function () {
        function AddressCtrl($scope, $networking) {
            $networking.get('api/shop/cart', function (data) {
                console.log(data);
                $scope.data = data;
            });
        }
        return AddressCtrl;
    })();
    shop.AddressCtrl = AddressCtrl;
})(shop || (shop = {}));
/// <reference path="../typings/tsd.d.ts" />
/// <reference path="Boot.ts" />
/// <reference path="controllers/ShopCtrl.ts" />
/// <reference path="controllers/ProfileCtrl.ts" />
/// <reference path="controllers/CartCtrl.ts" />
/// <reference path="controllers/MyOrderCtrl.ts" />
/// <reference path="controllers/CheckoutCtrl.ts" />
/// <reference path="controllers/AddressCtrl.ts" />
var app = angular.module("shop", ['ui.router'])
    .config(['$urlRouterProvider', '$stateProvider', function ($urlRouterProvider, $stateProvider) {
        $urlRouterProvider.otherwise('/');
        $stateProvider
            .state('shop', {
            url: '/',
            templateUrl: '/assets/shop/views/shop.html',
            controller: shop.ShopCtrl
        })
            .state('search', {
            url: '/search',
            templateUrl: '/assets/shop/views/search.html',
            controller: shop.ShopCtrl
        })
            .state('cart', {
            url: '/cart',
            templateUrl: '/assets/shop/views/cart.html',
            controller: shop.CartCtrl
        })
            .state('profile', {
            url: '/profile',
            templateUrl: '/assets/shop/views/profile.html',
            controller: shop.ProfileCtrl
        })
            .state('myorder', {
            url: '/profile/order?status',
            templateUrl: '/assets/shop/views/myorder.html',
            controller: shop.MyOrderCtrl
        })
            .state('checkout', {
            url: '/checkout',
            templateUrl: '/assets/shop/views/checkout.html',
            controller: shop.CheckoutCtrl
        })
            .state('address', {
            url: '/address',
            templateUrl: '/assets/shop/views/address.html',
            controller: shop.AddressCtrl
        });
    }]);
/// <reference path="Shop.ts" />
var user;
angular.element(document).ready(function () {
    angular.injector(['ng']).get('$http').get('api/auth')
        .then(function success(response) {
        if (response.data.status) {
            user = response.data.result;
            //console.log(user);
            angular.bootstrap(document, ['shop']);
        }
        else {
            console.log('error---');
            alert('b');
        }
    })
        .then(null, function failure(error) {
        console.log('error---', error);
        alert('a');
    });
    // angular.bootstrap(document, ['shop']);
});
/// <reference path="../Shop.ts" />
app.service('$networking', function ($http, $log, $rootScope) {
    // 检查是否登录
    this.get = function (path, callback) {
        $http.get(path).success(function (data) {
            if (data.status == true) {
                callback(data.result);
            }
        });
    };
});
